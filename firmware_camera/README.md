# Прошивка для камеры робота-черепахи
Прошивка позволяет через microROS передавать изображение с камеры в топик ROS2 Humble.

## Оглавление

1. [Описание проекта](#описание-проекта)
2. [Схема подключения](#схема-подключения)
3. [Установка и прошивка](#установка-и-прошивка)
   1. [Установка PlatformIO](#установка-platformio)
   2. [Настройка проекта](#настройка-проекта)
   3. [Прошивка модуля](#прошивка-модуля)
   4. [Обновление прошивки через OTA](#обновление-прошивки-через-ota)
4. [Руководство по эксплуатации](#руководство-по-эксплуатации)
   1. [Описание топиков](#описание-топиков)
   2. [Параметры](#параметры)
   3. [Использование USB интерфейса](#использование-usb-интерфейса)
   4. [Использование беспроводного интерфейса](#использование-беспроводного-интерфейса)
   5. [Примеры запросов](#примеры-запросов)
5. [Дополнительные сведения](#дополнительные-сведения)

## Описание проекта

Прошивка для микроконтроллера ESP32-CAM обеспечивает захват видеопотока с камеры OV2640 и его публикацию в топик microROS через Wi-Fi. Она поддерживает настройку через HTTP-сервер и обновление по OTA с использованием ElegantOTA.

## Схема подключения

Для работы проекта вам понадобится только подключить к 5V и GND провода от понижающего модуля.

## Установка и прошивка

### Установка PlatformIO

1. Установите [Visual Studio Code](https://code.visualstudio.com/).  
2. Установите расширение [PlatformIO](https://platformio.org/install/ide?install=vscode).  

### Настройка проекта

1. Склонируйте репозиторий проекта:  
   ```sh
   git clone https://github.com/ShiWarai/microros-turtle
   ```
2. Откройте проект в Visual Studio Code.  
3. Убедитесь, что файл `platformio.ini` настроен правильно. См. пример в репозитории.  
4. Создайте файл `secret_values.ini` в корне проекта с содержимым:  
   ```ini
   [secrets]
   build_flags = 
       '-D WIFI_SSID="your_wifi_ssid"'
       '-D WIFI_PASSWORD="your_wifi_password"'
       '-D ACCESS_KEY="your_access_key"'
       '-D AGENT_IP="192.168.0.116"'
       '-D AGENT_PORT=8888'
    ```

## Прошивка модуля
1. Подключите ESP32-CAM к компьютеру через USB-UART адаптер.  
2. В Visual Studio Code откройте терминал PlatformIO и выполните:  
   ```sh
   pio run --target upload
   ```
3. Дождитесь завершения процесса прошивки. Для отладки используйте монитор:  
    ```sh
    pio device monitor
    ```

## Обновление прошивки через OTA
1. Подключите устройство к Wi-Fi сети.  
2. Откройте веб-браузер и перейдите по адресу:  
   ```plaintext
   http://cam_turtle_2.local/update
   ```
3. В интерфейсе ElegantOTA загрузите новую прошивку и подтвердите обновление.

## Руководство по эксплуатации

### Описание топиков

Прошивка публикует видеопоток в microROS через следующий топик:  

- **/camera/image_raw**  
  **Тип сообщения**: `sensor_micro_msgs/msg/CompressedImage`  
  **Описание**: Публикует сжатые изображения в формате JPEG с камеры OV2640. Размер кадра — 240x240 пикселей, качество JPEG — 10. Частота публикации — каждые 10 мс. Фрейм: `camera_frame`.  

### Параметры

Основные параметры, которые можно настроить:  
- `turtle_id`: идентификатор камеры (например, 2).  
- `wifi_ssid`: SSID Wi-Fi сети.  
- `wifi_password`: пароль Wi-Fi сети.  
- `access_key`: ключ доступа к HTTP-серверу.  
- `agent_ip`: IP-адрес агента ROS (например, "192.168.0.116").  
- `agent_port`: порт агента ROS (например, 8888).  

### Использование USB интерфейса

Для отладки используйте монитор порта (115200 бод). Логи выводятся в зависимости от уровня `LOG_LOCAL_LEVEL` (по умолчанию `ESP_LOG_VERBOSE`).

### Использование беспроводного интерфейса

Устройство поддерживает HTTP-сервер через Wi-Fi. Основные эндпоинты:  
- `/ping`: проверка доступности устройства.  
- `/settings`: получение или обновление настроек.  
- `/update`: загрузка новой прошивки через ElegantOTA.
- `/restart`: выполняет перезапуск микроконтроллера (POST).

Для работы рекомендую использовать [Postman](https://www.postman.com/). Экспортируйте конфигурацию со всеми эндпоитами для работы с примерами (файл `utils/API робота-черепахи.postman_collection.json`), но не забудьте указать api_key и имя устройства (или же IP-адрес).

### Примеры запросов

- **Проверка доступности**:  
    ```http
    GET /ping HTTP/1.1
    Host: cam_turtle_2.local
    api_key: your_access_key
    ```
- **Обновление настроек**:  
    ```http
    POST /settings HTTP/1.1
    Host: cam_turtle_2.local
    Content-Type: application/json
    api_key: your_access_key
    Content-Length: 75

    {
        "wifi_ssid": "new_ssid",
        "wifi_password": "new_password"
    }
    ```

## Дополнительные сведения
Для более подробной информации о проекте и его настройке ознакомьтесь с исходным кодом и комментариями в файлах проекта.  
- Прошивка интегрирована с microROS для публикации видеопотока в ROS (требуется указать дистрибутив ROS через `ROS_DISTRO`).  
- Камера настроена на модель AI-Thinker с использованием PSRAM для обработки изображений.  
